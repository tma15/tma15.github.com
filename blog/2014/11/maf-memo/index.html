<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>mafが便利そう</title>

 	
    <link href="/css/journal.css" rel="stylesheet">

 	
    <link href="/css/style.css" rel="stylesheet">

    <link rel="alternate" type="application/atom+xml"  href="/blog/index.xml" >
</head>
<body lang="en">
	<div class="container">
		<div class="row">
			<div class="navbar navbar-default navbar-inverse" role="navigation">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="">Now is better than never.</a> 
				</div>
				<div class="navbar-collapse collapse navbar-responsive-collapse">
					<ul class="nav navbar-nav navbar-right">
						<li><a href="">Home</a></li>
						<li><a href="/about/">About</a></li>
						<li><a href="/blog/">Blog</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>


<div class="container">	
	<div class="row">
		<div class="col-md-offset-1 col-md-10">
			<h3>mafが便利そう</h3>
				<span class="label label-primary">Mon Nov 3, 2014</span> in 
				 using tags 			 
				
					
					<a href="/tags/python">python</a>
				
			</small>
		</div>
	</div>
	<div class="row">
		<div class="col-md-offset-1 col-md-10">
			<br>
			

<h2 id="概要:7a3ae7300e2315ccfba2a2a08e8ab28a">概要</h2>

<p><a href="https://github.com/pfi/maf">maf</a>というツールが便利そうだったのでメモ。
評価のために必要なめんどくさい処理が簡略化されそうな気がする。
実験結果の管理などがヘタなので、mafを使ってちょっとでもうまくなりたい。
まだ調べ始めたばかりなので、以降で出てくるコードよりももっとうまい書き方があると思う。</p>

<p>今回は色々とパラメータを変えて学習した分類器を評価する例で進める。</p>

<h2 id="使ってみた:7a3ae7300e2315ccfba2a2a08e8ab28a">使ってみた</h2>

<p>まず、wafとmafとダウンロードする。</p>

<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #906030">$cd</span> /path/to/project/
<span style="color: #906030">$wget</span> https://github.com/pfi/maf/raw/master/waf
<span style="color: #906030">$wget</span> https://github.com/pfi/maf/raw/master/maf.py
<span style="color: #906030">$chmod</span> +x waf
</pre></div>
</p>

<p>以下の様な <a href="https://gist.github.com/tma15/1d7bd594d5be774ca6e9">wscript</a> を作成。</p>

<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #808080">#!/usr/bin/python</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">re</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">json</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">maf</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">maflib.util</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0060B0; font-weight: bold">configure</span>(conf):
    <span style="color: #008000; font-weight: bold">pass</span>

<span style="color: #505050; font-weight: bold">@maflib.util.rule</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0060B0; font-weight: bold">jsonize</span>(task):
    <span style="color: #D04020">&quot;&quot;&quot; Calculate accuracy from a format as below:</span>

<span style="color: #D04020">        Recall[-1]: 0.932965 (21934/23510)</span>
<span style="color: #D04020">        Prec[-1]: 0.849562 (21934/25818)</span>
<span style="color: #D04020">        --</span>
<span style="color: #D04020">        Recall[+1]: 0.478378 (3562/7446)</span>
<span style="color: #D04020">        Prec[+1]: 0.693266 (3562/5138)</span>
<span style="color: #D04020">    &quot;&quot;&quot;</span>
    out <span style="color: #303030">=</span> task<span style="color: #303030">.</span>parameter
    <span style="color: #008000; font-weight: bold">with</span> <span style="color: #007020">open</span>(task<span style="color: #303030">.</span>inputs[<span style="color: #0000D0; font-weight: bold">0</span>]<span style="color: #303030">.</span>abspath(), <span style="background-color: #fff0f0">&#39;r&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> f:
        num <span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">0</span>
        num_trues <span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">0</span>
        <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #000000; font-weight: bold">in</span> f:
            <span style="color: #008000; font-weight: bold">if</span> line<span style="color: #303030">.</span>startswith(<span style="background-color: #fff0f0">&quot;Prec&quot;</span>):
                sp <span style="color: #303030">=</span> line<span style="color: #303030">.</span>split()
                nums <span style="color: #303030">=</span> re<span style="color: #303030">.</span>search(<span style="background-color: #fff0f0">&quot;(\d+)/(\d+)&quot;</span>, sp[<span style="color: #0000D0; font-weight: bold">2</span>])<span style="color: #303030">.</span>groups()
                num_trues <span style="color: #303030">+=</span> <span style="color: #007020">int</span>(nums[<span style="color: #0000D0; font-weight: bold">0</span>])
                num <span style="color: #303030">+=</span> <span style="color: #007020">int</span>(nums[<span style="color: #0000D0; font-weight: bold">1</span>])
        out[<span style="background-color: #fff0f0">&quot;accuracy&quot;</span>] <span style="color: #303030">=</span> num_trues <span style="color: #303030">/</span> <span style="color: #007020">float</span>(num)
    <span style="color: #008000; font-weight: bold">with</span> <span style="color: #007020">open</span>(task<span style="color: #303030">.</span>outputs[<span style="color: #0000D0; font-weight: bold">0</span>]<span style="color: #303030">.</span>abspath(), <span style="background-color: #fff0f0">&#39;w&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> f:
        json<span style="color: #303030">.</span>dump(out, f)

<span style="color: #505050; font-weight: bold">@maflib.util.rule</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0060B0; font-weight: bold">aggregate_by_alg</span>(task):
    out <span style="color: #303030">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> task<span style="color: #303030">.</span>inputs:
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #007020">open</span>(i<span style="color: #303030">.</span>abspath(), <span style="background-color: #fff0f0">&#39;r&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> f:
            out<span style="color: #303030">.</span>append(json<span style="color: #303030">.</span>load(f))
    <span style="color: #008000; font-weight: bold">with</span> <span style="color: #007020">open</span>(task<span style="color: #303030">.</span>outputs[<span style="color: #0000D0; font-weight: bold">0</span>]<span style="color: #303030">.</span>abspath(), <span style="background-color: #fff0f0">&#39;w&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> f:
        json<span style="color: #303030">.</span>dump(out, f)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0060B0; font-weight: bold">aggregate_by_param</span>():
    <span style="color: #505050; font-weight: bold">@maflib.util.aggregator</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0060B0; font-weight: bold">body</span>(values, outpath, parameter):
        out <span style="color: #303030">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> value <span style="color: #000000; font-weight: bold">in</span> values:
            out<span style="color: #303030">.</span>append(value)
        <span style="color: #008000; font-weight: bold">return</span> json<span style="color: #303030">.</span>dumps(out)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0060B0; font-weight: bold">build</span>(exp):
    traindata<span style="color: #303030">=</span><span style="background-color: #fff0f0">&#39;a1a&#39;</span>
    train <span style="color: #303030">=</span> <span style="background-color: #fff0f0">&#39;~/go/src/github.com/tma15/gonline/gonline/gonline train&#39;</span>
    test <span style="color: #303030">=</span> <span style="background-color: #fff0f0">&#39;~/go/src/github.com/tma15/gonline/gonline/gonline test&#39;</span>

    NUM_FOLD <span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">3</span>
    exp(source<span style="color: #303030">=</span>traindata,
        target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;train dev&quot;</span>,
        parameters<span style="color: #303030">=</span>[{<span style="background-color: #fff0f0">&quot;fold&quot;</span>: i} <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">xrange</span>(NUM_FOLD)],
        rule<span style="color: #303030">=</span>maflib<span style="color: #303030">.</span>rules<span style="color: #303030">.</span>segment_by_line(NUM_FOLD, <span style="background-color: #fff0f0">&#39;fold&#39;</span>))

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;train&quot;</span>,
        target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;model&quot;</span>,
        parameters<span style="color: #303030">=</span>maflib<span style="color: #303030">.</span>util<span style="color: #303030">.</span>product({
            <span style="background-color: #fff0f0">&quot;a&quot;</span>: [<span style="background-color: #fff0f0">&quot;perceptron&quot;</span>, <span style="background-color: #fff0f0">&quot;pa2&quot;</span>, <span style="background-color: #fff0f0">&quot;adagrad&quot;</span>],
            <span style="background-color: #fff0f0">&quot;c&quot;</span>: np<span style="color: #303030">.</span>power(<span style="color: #6000E0; font-weight: bold">10.</span>, np<span style="color: #303030">.</span>arange(<span style="color: #303030">-</span><span style="color: #0000D0; font-weight: bold">12</span>, <span style="color: #303030">-</span><span style="color: #0000D0; font-weight: bold">5</span>, dtype<span style="color: #303030">=</span>np<span style="color: #303030">.</span>float64)),
            }),
        rule<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;</span><span style="background-color: #e0e0e0">%s</span><span style="background-color: #fff0f0"> -a ${a} -m ${TGT[0].abspath()} ${SRC[0].abspath()}&quot;</span> <span style="color: #303030">%</span> train)

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;model dev&quot;</span>,
        target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;dev_result&quot;</span>,
        rule<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;</span><span style="background-color: #e0e0e0">%s</span><span style="background-color: #fff0f0"> -m ${SRC[0].abspath()} ${SRC[1].abspath()} &gt; ${TGT[0].abspath()}&quot;</span> <span style="color: #303030">%</span> test)

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;dev_result&quot;</span>,
            target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;accuracy&quot;</span>,
            rule<span style="color: #303030">=</span>jsonize) <span style="color: #808080">### パラメータごとのaccuracyをjson形式で出力</span>

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;accuracy&quot;</span>,
        target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;accuracies_by_param&quot;</span>,
        for_each<span style="color: #303030">=</span>[<span style="background-color: #fff0f0">&quot;a&quot;</span>, <span style="background-color: #fff0f0">&quot;c&quot;</span>],
        rule<span style="color: #303030">=</span>aggregate_by_param()) <span style="color: #808080">### パラメータ毎にaccuracyを集約する</span>

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;accuracies_by_param&quot;</span>,
        target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;avg_acc&quot;</span>,
        aggregate_by<span style="color: #303030">=</span>[<span style="background-color: #fff0f0">&quot;fold&quot;</span>],
        rule<span style="color: #303030">=</span>maflib<span style="color: #303030">.</span>rules<span style="color: #303030">.</span>average) <span style="color: #808080">### パラメータ毎の平均を計算</span>

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;avg_acc&quot;</span>,
            target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;for_each_alg&quot;</span>, 
            for_each<span style="color: #303030">=</span>[<span style="background-color: #fff0f0">&quot;a&quot;</span>],
            rule<span style="color: #303030">=</span>aggregate_by_alg) <span style="color: #808080">## アルゴリズム毎に集約</span>

    exp(source<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;for_each_alg&quot;</span>,
            target<span style="color: #303030">=</span><span style="background-color: #fff0f0">&quot;max_acc&quot;</span>,
            aggregate_by <span style="color: #303030">=</span> [<span style="background-color: #fff0f0">&quot;fold&quot;</span>],
            rule<span style="color: #303030">=</span>maflib<span style="color: #303030">.</span>rules<span style="color: #303030">.</span>max(<span style="background-color: #fff0f0">&quot;accuracy&quot;</span>))
</pre></div>
</p>

<p>次のように実行。</p>

<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #906030">$ </span>./waf configure
Setting top to                           : /Users/makino/code/mafexp
Setting out to                           : /Users/makino/code/mafexp/build
<span style="background-color: #fff0f0">&#39;configure&#39;</span> finished successfully <span style="color: #303030">(</span>0.004s<span style="color: #303030">)</span>
<span style="color: #906030">$.</span>/waf
Waf: Entering directory <span style="background-color: #fff0f0">`</span>/Users/makino/code/mafexp/build<span style="background-color: #fff0f0">&#39;</span>
<span style="background-color: #fff0f0">[  2/240] 0-train,0-dev: a1a -&gt; build/train/0-train build/dev/0-dev</span>
<span style="background-color: #fff0f0">[  3/240] 1-train,1-dev: a1a -&gt; build/train/1-train build/dev/1-dev</span>
<span style="background-color: #fff0f0">[  3/240] 2-train,2-dev: a1a -&gt; build/train/2-train build/dev/2-dev</span>
<span style="background-color: #fff0f0">[  7/240] 19-model: build/train/1-train -&gt; build/model/19-model</span>
<span style="background-color: #fff0f0">[  7/240] 18-model: build/train/1-train -&gt; build/model/18-model</span>
<span style="background-color: #fff0f0">[  7/240] 22-model: build/train/1-train -&gt; build/model/22-model</span>
<span style="background-color: #fff0f0">...</span>
<span style="background-color: #fff0f0">[240/240] 87-max_acc: build/for_each_alg/87-for_each_alg -&gt; build/max_acc/87-max_acc</span>
<span style="background-color: #fff0f0">Waf: Leaving directory `/Users/makino/code/mafexp/build&#39;</span>
<span style="background-color: #fff0f0">&#39;build&#39;</span> finished successfully <span style="color: #303030">(</span>3.450s<span style="color: #303030">)</span>
</pre></div>
</p>

<h2 id="他に:7a3ae7300e2315ccfba2a2a08e8ab28a">他に</h2>

<p>出力のidは、 ./build/.maf_id_table.tsvで対応付けられている。</p>

<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #906030">$cat</span> ./build/.maf_id_table.tsv
0       <span style="color: #303030">{</span><span style="background-color: #fff0f0">&#39;fold&#39;</span>: 0<span style="color: #303030">}</span>
1       <span style="color: #303030">{</span><span style="background-color: #fff0f0">&#39;fold&#39;</span>: 1<span style="color: #303030">}</span>
2       <span style="color: #303030">{</span><span style="background-color: #fff0f0">&#39;fold&#39;</span>: 2<span style="color: #303030">}</span>
3       <span style="color: #303030">{</span><span style="background-color: #fff0f0">&#39;a&#39;</span>: <span style="background-color: #fff0f0">&#39;perceptron&#39;</span>, <span style="background-color: #fff0f0">&#39;fold&#39;</span>: 1, <span style="background-color: #fff0f0">&#39;c&#39;</span>: 9.9999999999999998e-13<span style="color: #303030">}</span>
4       <span style="color: #303030">{</span><span style="background-color: #fff0f0">&#39;a&#39;</span>: <span style="background-color: #fff0f0">&#39;perceptron&#39;</span>, <span style="background-color: #fff0f0">&#39;fold&#39;</span>: 1, <span style="background-color: #fff0f0">&#39;c&#39;</span>: 9.9999999999999994e-12<span style="color: #303030">}</span>
...
</pre></div>
</p>

<p>また、結果を集約するときなどは、<a href="http://pfi.github.io/maf/usage.html#json">JSON形式でデータを扱う必要がある</a> ので、分類器の出力をJSON形式に加工する関数を作らなければならない。
GitHubにある <a href="https://github.com/pfi/maf/tree/master/samples">サンプルコード</a> が参考になる。</p>

<h2 id="参考:7a3ae7300e2315ccfba2a2a08e8ab28a">参考</h2>

<ul>
<li><a href="//d.hatena.ne.jp/tanakh/20100212">waf チュートリアル</a></li>
<li><a href="http://pfi.github.io/maf/usage.html">mafの使い方</a></li>
<li><a href="http://research.preferred.jp/2013/12/maf/">データ解析作業の救世主！ 超絶☆実験ビルドシステムmafをOSS公開しました</a></li>
</ul>

		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<hr>
		</div>
	</div>	
        <div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = 'nowisbetterthannever'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>

  <div class="container">
    <div class="row col-md-12">
          <footer>
            <div>
                <p>
                    &copy; 2014  ~ Powered By <a href="http://hugo.spf13.com">Hugo</a>
                </p>
            </div>
            </footer>
        </div>
    </div>

    
    
    <script src="/js/jquery-min-2.1.1.js"></script>
    <script src="/js/bootstrap.min-3.1.1.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: { inlineMath: [['$','$'],['\\(','\\)']] }
        });
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-20414370-4']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    </body>
</html>

