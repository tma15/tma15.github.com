<!doctype html>
<html lang="ja">
    <head>
        <link href="http://fonts.googleapis.com/css?family=Anton" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Bubblegum+Sans' rel='stylesheet' type='text/css'>
        <title>mafが便利そう | Now is better than never.</title>
        <meta charset="utf-8" />
        <link href='http://fonts.googleapis.com/css?family=Permanent+Marker' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/media/css/font-awesome.css">
        <link rel="stylesheet" href="/media/css/style.css">
        <link rel="stylesheet" href="/media/css/pygments.css">
        <link rel="shortcut icon" href="/media/img/background.jpg">
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: { inlineMath: [['$','$'],['\\(','\\)']] }
            });
        </script>
        <script type='text/javascript' src='http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
        <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js">
        </script>
        <![endif]-->
    </head>
    <body >
        <header>
            <hgroup>
              <h1>Now is better than never.</h1>
              <h3>Although never is often better than right now.</h3>
            </hgroup>
        </header>
        <nav>
                                <ul>
<li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/blog">Blog</a></li><li><a href="/blog/archive.html">Archive</a></li></ul>
        </nav>
        <article id="content">
                    <h1>mafが便利そう</h1>
              <div class="tags">
        Tags:
            <a class="small" href="/blog/tags/python.html">python</a>&nbsp;
            <br>
  </div>
            <h2>概要</h2>
<p><a href="https://github.com/pfi/maf">maf</a>というツールが便利そうだったのでメモ。
評価のために必要なめんどくさい処理が簡略化されそうな気がする。
実験結果の管理などがヘタなので、mafを使ってちょっとでもうまくなりたい。
まだ調べ始めたばかりなので、以降で出てくるコードよりももっとうまい書き方があると思う。</p>
<p>今回は色々とパラメータを変えて学習した分類器を評価する例で進める。</p>
<h2>使ってみた</h2>
<p>まず、wafとmafとダウンロードする。</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$cd</span> /path/to/project/<br /><span class="nv">$wget</span> https://github.com/pfi/maf/raw/master/waf<br /><span class="nv">$wget</span> https://github.com/pfi/maf/raw/master/maf.py<br /><span class="nv">$chmod</span> +x waf<br /></pre></div><br /></figure></div>

<p>以下の様な <a href="https://gist.github.com/tma15/1d7bd594d5be774ca6e9">wscript</a> を作成。</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span><br /><span class="kn">import</span> <span class="nn">re</span><br /><span class="kn">import</span> <span class="nn">json</span><br /><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span><br /><span class="kn">import</span> <span class="nn">maf</span><br /><span class="kn">import</span> <span class="nn">maflib.util</span><br />&nbsp;<br /><span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span><br />    <span class="k">pass</span><br />&nbsp;<br /><span class="nd">@maflib.util.rule</span><br /><span class="k">def</span> <span class="nf">jsonize</span><span class="p">(</span><span class="n">task</span><span class="p">):</span><br />    <span class="sd">&quot;&quot;&quot; Calculate accuracy from a format as below:</span><br />&nbsp;<br /><span class="sd">        Recall[-1]: 0.932965 (21934/23510)</span><br /><span class="sd">        Prec[-1]: 0.849562 (21934/25818)</span><br /><span class="sd">        --</span><br /><span class="sd">        Recall[+1]: 0.478378 (3562/7446)</span><br /><span class="sd">        Prec[+1]: 0.693266 (3562/5138)</span><br /><span class="sd">    &quot;&quot;&quot;</span><br />    <span class="n">out</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">parameter</span><br />    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abspath</span><span class="p">(),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br />        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><br />        <span class="n">num_trues</span> <span class="o">=</span> <span class="mi">0</span><br />        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span><br />            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;Prec&quot;</span><span class="p">):</span><br />                <span class="n">sp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><br />                <span class="n">nums</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;(\d+)/(\d+)&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span><br />                <span class="n">num_trues</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><br />                <span class="n">num</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><br />        <span class="n">out</span><span class="p">[</span><span class="s">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_trues</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><br />    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abspath</span><span class="p">(),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br />        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><br />&nbsp;<br /><span class="nd">@maflib.util.rule</span><br /><span class="k">def</span> <span class="nf">aggregate_by_alg</span><span class="p">(</span><span class="n">task</span><span class="p">):</span><br />    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span><br />    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span><br />        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">abspath</span><span class="p">(),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br />            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><br />    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abspath</span><span class="p">(),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span><br />        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><br />&nbsp;<br /><span class="k">def</span> <span class="nf">aggregate_by_param</span><span class="p">():</span><br />    <span class="nd">@maflib.util.aggregator</span><br />    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span><br />        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span><br />        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span><br />            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><br />        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><br />&nbsp;<br /><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span><br />    <span class="n">traindata</span><span class="o">=</span><span class="s">&#39;a1a&#39;</span><br />    <span class="n">train</span> <span class="o">=</span> <span class="s">&#39;~/go/src/github.com/tma15/gonline/gonline/gonline train&#39;</span><br />    <span class="n">test</span> <span class="o">=</span> <span class="s">&#39;~/go/src/github.com/tma15/gonline/gonline/gonline test&#39;</span><br />&nbsp;<br />    <span class="n">NUM_FOLD</span> <span class="o">=</span> <span class="mi">3</span><br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">traindata</span><span class="p">,</span><br />        <span class="n">target</span><span class="o">=</span><span class="s">&quot;train dev&quot;</span><span class="p">,</span><br />        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="s">&quot;fold&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">NUM_FOLD</span><span class="p">)],</span><br />        <span class="n">rule</span><span class="o">=</span><span class="n">maflib</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">segment_by_line</span><span class="p">(</span><span class="n">NUM_FOLD</span><span class="p">,</span> <span class="s">&#39;fold&#39;</span><span class="p">))</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;train&quot;</span><span class="p">,</span><br />        <span class="n">target</span><span class="o">=</span><span class="s">&quot;model&quot;</span><span class="p">,</span><br />        <span class="n">parameters</span><span class="o">=</span><span class="n">maflib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">product</span><span class="p">({</span><br />            <span class="s">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;perceptron&quot;</span><span class="p">,</span> <span class="s">&quot;pa2&quot;</span><span class="p">,</span> <span class="s">&quot;adagrad&quot;</span><span class="p">],</span><br />            <span class="s">&quot;c&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span><br />            <span class="p">}),</span><br />        <span class="n">rule</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> -a ${a} -m ${TGT[0].abspath()} ${SRC[0].abspath()}&quot;</span> <span class="o">%</span> <span class="n">train</span><span class="p">)</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;model dev&quot;</span><span class="p">,</span><br />        <span class="n">target</span><span class="o">=</span><span class="s">&quot;dev_result&quot;</span><span class="p">,</span><br />        <span class="n">rule</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> -m ${SRC[0].abspath()} ${SRC[1].abspath()} &gt; ${TGT[0].abspath()}&quot;</span> <span class="o">%</span> <span class="n">test</span><span class="p">)</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;dev_result&quot;</span><span class="p">,</span><br />            <span class="n">target</span><span class="o">=</span><span class="s">&quot;accuracy&quot;</span><span class="p">,</span><br />            <span class="n">rule</span><span class="o">=</span><span class="n">jsonize</span><span class="p">)</span> <span class="c">### パラメータごとのaccuracyをjson形式で出力</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;accuracy&quot;</span><span class="p">,</span><br />        <span class="n">target</span><span class="o">=</span><span class="s">&quot;accuracies_by_param&quot;</span><span class="p">,</span><br />        <span class="n">for_each</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">],</span><br />        <span class="n">rule</span><span class="o">=</span><span class="n">aggregate_by_param</span><span class="p">())</span> <span class="c">### パラメータ毎にaccuracyを集約する</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;accuracies_by_param&quot;</span><span class="p">,</span><br />        <span class="n">target</span><span class="o">=</span><span class="s">&quot;avg_acc&quot;</span><span class="p">,</span><br />        <span class="n">aggregate_by</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;fold&quot;</span><span class="p">],</span><br />        <span class="n">rule</span><span class="o">=</span><span class="n">maflib</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">average</span><span class="p">)</span> <span class="c">### パラメータ毎の平均を計算</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;avg_acc&quot;</span><span class="p">,</span><br />            <span class="n">target</span><span class="o">=</span><span class="s">&quot;for_each_alg&quot;</span><span class="p">,</span> <br />            <span class="n">for_each</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">],</span><br />            <span class="n">rule</span><span class="o">=</span><span class="n">aggregate_by_alg</span><span class="p">)</span> <span class="c">## アルゴリズム毎に集約</span><br />&nbsp;<br />    <span class="n">exp</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;for_each_alg&quot;</span><span class="p">,</span><br />            <span class="n">target</span><span class="o">=</span><span class="s">&quot;max_acc&quot;</span><span class="p">,</span><br />            <span class="n">aggregate_by</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;fold&quot;</span><span class="p">],</span><br />            <span class="n">rule</span><span class="o">=</span><span class="n">maflib</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s">&quot;accuracy&quot;</span><span class="p">))</span><br /></pre></div><br /></figure></div>

<p>次のように実行。</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$ </span>./waf configure<br />Setting top to                           : /Users/makino/code/mafexp<br />Setting out to                           : /Users/makino/code/mafexp/build<br /><span class="s1">&#39;configure&#39;</span> finished successfully <span class="o">(</span>0.004s<span class="o">)</span><br /><span class="nv">$.</span>/waf<br />Waf: Entering directory <span class="sb">`</span>/Users/makino/code/mafexp/build<span class="s1">&#39;</span><br /><span class="s1">[  2/240] 0-train,0-dev: a1a -&gt; build/train/0-train build/dev/0-dev</span><br /><span class="s1">[  3/240] 1-train,1-dev: a1a -&gt; build/train/1-train build/dev/1-dev</span><br /><span class="s1">[  3/240] 2-train,2-dev: a1a -&gt; build/train/2-train build/dev/2-dev</span><br /><span class="s1">[  7/240] 19-model: build/train/1-train -&gt; build/model/19-model</span><br /><span class="s1">[  7/240] 18-model: build/train/1-train -&gt; build/model/18-model</span><br /><span class="s1">[  7/240] 22-model: build/train/1-train -&gt; build/model/22-model</span><br /><span class="s1">...</span><br /><span class="s1">[240/240] 87-max_acc: build/for_each_alg/87-for_each_alg -&gt; build/max_acc/87-max_acc</span><br /><span class="s1">Waf: Leaving directory `/Users/makino/code/mafexp/build&#39;</span><br /><span class="s1">&#39;build&#39;</span> finished successfully <span class="o">(</span>3.450s<span class="o">)</span><br /></pre></div><br /></figure></div>

<h2>他に</h2>
<p>出力のidは、 ./build/.maf_id_table.tsvで対応付けられている。</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="nv">$cat</span> ./build/.maf_id_table.tsv<br />0       <span class="o">{</span><span class="s1">&#39;fold&#39;</span>: 0<span class="o">}</span><br />1       <span class="o">{</span><span class="s1">&#39;fold&#39;</span>: 1<span class="o">}</span><br />2       <span class="o">{</span><span class="s1">&#39;fold&#39;</span>: 2<span class="o">}</span><br />3       <span class="o">{</span><span class="s1">&#39;a&#39;</span>: <span class="s1">&#39;perceptron&#39;</span>, <span class="s1">&#39;fold&#39;</span>: 1, <span class="s1">&#39;c&#39;</span>: 9.9999999999999998e-13<span class="o">}</span><br />4       <span class="o">{</span><span class="s1">&#39;a&#39;</span>: <span class="s1">&#39;perceptron&#39;</span>, <span class="s1">&#39;fold&#39;</span>: 1, <span class="s1">&#39;c&#39;</span>: 9.9999999999999994e-12<span class="o">}</span><br />...<br /></pre></div><br /></figure></div>

<p>また、結果を集約するときなどは、<a href="http://pfi.github.io/maf/usage.html#json">JSON形式でデータを扱う必要がある</a> ので、分類器の出力をJSON形式に加工する関数を作らなければならない。
GitHubにある <a href="https://github.com/pfi/maf/tree/master/samples">サンプルコード</a> が参考になる。</p>
<h2>参考</h2>
<ul>
<li><a href="//d.hatena.ne.jp/tanakh/20100212">waf チュートリアル</a></li>
<li><a href="http://pfi.github.io/maf/usage.html">mafの使い方</a></li>
<li><a href="http://research.preferred.jp/2013/12/maf/">データ解析作業の救世主！ 超絶☆実験ビルドシステムmafをOSS公開しました</a></li>
</ul>
        <br>
        <time datetime="2014-11-03">
    Mon, 03 Nov 2014
</time>
        <div class="bottom_article_nav">

                  <div class="next"><a href="/blog/2014/10/hmm.html">HMMを実装した</a>
    &gt;</div>


</div>

<div class="center"><a href="/blog/archive.html">archive</a></div>
        </article>

                <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20414370-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>    </body>
</html>